version: '3.8'

services:
  # RTMP Relay (existing - for camera ingestion)
  rtmp-relay:
    build: ./nginx-rtmp
    container_name: vistterstream-rtmp-relay
    ports:
      - "1935:1935"  # RTMP port for camera feeds
      - "8081:8080"  # HTTP stats/HLS
    restart: unless-stopped
    networks:
      - vistter-network

  # Preview Server (NEW - for timeline preview)
  preview-server:
    image: bluenviron/mediamtx:latest
    container_name: vistterstream-preview
    ports:
      - "1936:1935"  # RTMP ingest (different port to avoid conflict)
      - "8888:8888"  # HLS output
      - "9997:9997"  # API
    volumes:
      - ./mediamtx/mediamtx.yml:/mediamtx.yml:ro
    restart: unless-stopped
    networks:
      - vistter-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9997/v1/config/get", "||", "exit", "0"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # Cloudflare Tunnel (optional - for remote access without port forwarding)
  # Requires CLOUDFLARE_TUNNEL_TOKEN environment variable
  # See docs/CLOUDFLARE_TUNNEL_SETUP.md for setup instructions
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: vistterstream-cloudflared
    # Use token-based auth if token is provided, otherwise use config file
    command: >
      sh -c "
      if [ -n \"$$CLOUDFLARE_TUNNEL_TOKEN\" ]; then
        cloudflared tunnel --token $$CLOUDFLARE_TUNNEL_TOKEN run
      else
        cloudflared tunnel --config /etc/cloudflared/config.yml run
      fi
      "
    environment:
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    volumes:
      - ./cloudflared/config.yml:/etc/cloudflared/config.yml:ro
      - cloudflared_creds:/etc/cloudflared
    restart: unless-stopped
    networks:
      - vistter-network
    profiles:
      - cloudflare

volumes:
  cloudflared_creds:

networks:
  vistter-network:
    driver: bridge
